#!/bin/sh
set -e

# The "-H" is only for compatibility with the old way of doing CoW
# The "--safe-links" is there for to prevent sync'ing symlinks created by
# bitbake, pointing to local SSTATE_MIRRORS
: ${RSYNC:=rsync -a --info=stats2 -H --safe-links}

die() {
    echo >&2 "ERROR: $*"
    exit 1
}

GEN=""
DST=""
PORT=""
while [ $# -gt 1 ]; do
    case "$1" in
        --sstate-gen)
            GEN="$2"
            shift
            ;;
        --rsync-to)
            DST="$2"
            shift
            ;;
        --ssh-port)
            PORT="$2"
            shift
            ;;
        --)
            shift
            break
            ;;
        -*)
            die "unknown flag '$1'"
            ;;
        *)
            break
            ;;
    esac
    shift
done

[ -n "$GEN" ] || die "missing --sstate-gen"
[ -n "$DST" ] || die "missing --rsync-to"

# gitlab does not allow to set empty variables
PORT=$(echo $PORT)

if [ -n "$PORT" ]; then
    export RSYNC_RSH="ssh -p '$PORT'"
fi

SSTATE=~/sstate-cache-"${GEN}"

$RSYNC "$@" \
      $SSTATE \
      "$DST"
